<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformate en Guerrera</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para la estética */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e1e1e; /* Fondo oscuro */
            color: #f0f0f0; /* Texto claro */
        }
        /* Estilo del contenedor principal para centrar */
        #app-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        /* Estilo para los botones de acción */
        .action-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        /* Estilo para los botones primarios (Generar) */
        .btn-generate {
            background-color: #5D4037; /* Marrón/Bronce */
            color: white;
            border: 2px solid #A1887F;
        }
        .btn-generate:hover:not(:disabled) {
            background-color: #795548;
        }
        .btn-generate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Estilo para el botón de descarga */
        .btn-download {
            background-color: #007bff; /* Azul vibrante */
            color: white;
        }
        .btn-download:hover {
            background-color: #0056b3;
        }
        /* Estilo para el área de imagen y preview */
        .image-box {
            border: 2px solid #A1887F;
            border-radius: 8px;
            overflow: hidden;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            /* Asegura que el contenido esté centrado vertical y horizontalmente */
            text-align: center;
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app-container">
        <!-- Título -->
        <header class="text-center py-6 border-b border-gray-700 mb-8">
            <h1 class="text-4xl font-extrabold text-[#A1887F]">Transformate en Guerrera</h1>
            <p class="text-xl text-gray-400 mt-2">Convertí tu foto en una versión épica</p>
        </header>

        <!-- Contenedor principal de la aplicación -->
        <main>
            <div class="flex flex-col md:flex-row gap-8">

                <!-- Columna de Entrada (Subir Foto) -->
                <div class="flex-1">
                    <h2 class="text-center text-lg font-semibold mb-3 text-gray-300">Tu Foto</h2>
                    <div class="image-box relative">
                        <!-- El input de archivo está superpuesto al div para capturar clics en toda el área -->
                        <input type="file" id="image-input" accept="image/jpeg, image/png" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewFile(event)">
                        <img id="input-image" class="max-w-full max-h-full object-contain" src="https://placehold.co/300x300/333/ccc?text=Subir+Foto" alt="Preview de la imagen subida">
                    </div>
                    <!-- El botón simplemente simula el clic en el input de archivo -->
                    <button onclick="document.getElementById('image-input').click()" class="action-btn w-full mt-4 bg-gray-600 hover:bg-gray-700 text-white">Subir foto</button>
                </div>

                <!-- Columna de Salida (Guerrera Generada) -->
                <div class="flex-1">
                    <h2 class="text-center text-lg font-semibold mb-3 text-gray-300">Tu Guerrera</h2>
                    <div class="image-box relative">
                        <img id="output-image" class="max-w-full max-h-full object-contain" alt="Imagen de la guerrera generada" style="display: none;">
                        <div id="loading-spinner" class="hidden text-[#A1887F] text-2xl flex items-center flex-col justify-center">
                            <svg class="animate-spin h-8 w-8 text-white mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Generando...
                        </div>
                    </div>
                    <!-- Instrucciones de posteo (Inicialmente ocultas) -->
                    <div id="social-instructions" class="hidden mt-4 p-3 bg-gray-700 rounded-lg text-sm text-center">
                        <p class="font-bold mb-1 text-[#A1887F]">¡Transformación Exitosa!</p>
                        <p>Compartí tu transformación en Instagram mencionando al Gym y con el siguiente hashtag: <span class="text-white font-mono">#TransformateEnGuerrera</span></p>
                    </div>

                    <!-- Botones de Acción de Salida (Descarga) -->
                    <div class="mt-4 flex flex-col sm:flex-row gap-4">
                        <button id="generate-button" onclick="generateWarrior()" class="action-btn flex-1 btn-generate" disabled>
                            Genera tu Guerrera
                        </button>
                        <button id="download-button" onclick="downloadImage()" class="action-btn flex-1 btn-download hidden">
                            Descargar
                        </button>
                    </div>
                </div>

            </div>
        </main>

    </div>

    <script>
        // *** CONFIGURACIÓN Y ESTADO ***
        // ¡IMPORTANTE! Reemplaza las comillas vacías con tu clave de API de Google AI Studio.
        // Para que la app funcione fuera de este entorno, ESTO es obligatorio.
        const apiKey = "AIzaSyAfSgq-M7hOwpCsFJ7Y3FB1R9SbjdS3mqg"; 
        // URL para el modelo estable multimodal (Ideal para transformación imagen-a-imagen)
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const WARRIOR_PROMPT = "Transforma esta persona en una guerrera épica, con armadura de bronce, con una espada, estilo fotorrealista, iluminación dramática y textura detallada. Mantén los rasgos faciales de la persona.";
        const MAX_RETRIES = 5;
        
        let uploadedBase64Image = null; // Almacena la imagen subida en formato Base64
        let uploadedMimeType = null; // Almacena el tipo MIME del archivo subido

        // *** FUNCIONES DE UTILIDAD ***

        // Maneja la carga y el preview del archivo
        function previewFile(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('input-image');
            const generateButton = document.getElementById('generate-button');
            const downloadButton = document.getElementById('download-button');
            
            uploadedBase64Image = null; // Resetear la imagen anterior
            uploadedMimeType = null;
            downloadButton.classList.add('hidden');
            
            if (file) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    // 1. Mostrar preview
                    preview.src = e.target.result;
                    preview.style.display = 'block';

                    // 2. Almacenar Base64 y Tipo MIME
                    const base64Data = e.target.result.split(',')[1];
                    uploadedBase64Image = base64Data;
                    uploadedMimeType = file.type;
                    
                    // 3. Habilitar botón de generación
                    generateButton.disabled = false;
                };

                reader.readAsDataURL(file);
            } else {
                preview.src = "https://placehold.co/300x300/333/ccc?text=Subir+Foto";
                generateButton.disabled = true;
            }
        }
        
        // Maneja la descarga de la imagen generada
        function downloadImage() {
            const outputImage = document.getElementById('output-image');
            if (outputImage.src.startsWith('data:image/png;base64,')) {
                // Crea un enlace temporal para la descarga
                const a = document.createElement('a');
                a.href = outputImage.src;
                a.download = 'guerrera-transformada.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                console.error("No hay una imagen generada para descargar.");
            }
        }


        // *** LÓGICA DE GENERACIÓN DE IMAGEN (Modelo Multimodal) ***

        async function generateWarrior() {
            if (!uploadedBase64Image || !uploadedMimeType) {
                // Usamos la consola para errores no críticos para el usuario
                console.error('No hay imagen o tipo MIME cargado.');
                return;
            }
            if (!apiKey) {
                alert('¡Falta la clave de API! Por favor, ingrésala en el código.');
                return;
            }

            const generateButton = document.getElementById('generate-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            const outputImage = document.getElementById('output-image');
            const downloadButton = document.getElementById('download-button');
            const socialInstructions = document.getElementById('social-instructions');

            // --- UI: Inicio de la Carga ---
            generateButton.disabled = true;
            outputImage.style.display = 'none';
            downloadButton.classList.add('hidden');
            socialInstructions.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            const payload = {
                contents: [{
                    parts: [
                        { text: WARRIOR_PROMPT },
                        {
                            inlineData: {
                                mimeType: uploadedMimeType, // Usamos el MIME type real del archivo subido
                                data: uploadedBase64Image
                            }
                        }
                    ]
                }],
                // Usamos systemInstruction para dar contexto al modelo (opcional, pero ayuda)
                systemInstruction: {
                    parts: [{ text: "You are a creative image transformation assistant. Generate a single, high-quality, photorealistic image based on the input image and the user's request." }]
                }
            };

            let resultImage = null;
            let currentRetry = 0;
            
            while (currentRetry < MAX_RETRIES && resultImage === null) {
                try {
                    const response = await fetch(`${API_URL}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // Si la respuesta es 403 (Forbidden), tiramos un error para salir y mostrar mensaje
                    if (response.status === 403) {
                        throw new Error("403 Forbidden: La clave de API es inválida o está restringida.");
                    }
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    // El modelo multimodal retorna la imagen dentro de la respuesta
                    const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                    
                    if (base64Data) {
                        resultImage = `data:image/png;base64,${base64Data}`;
                    } else {
                        // Podría ser un error de seguridad o un filtro de contenido
                        throw new Error("Respuesta de API incompleta. No se generó la imagen o fue bloqueada.");
                    }
                    
                } catch (error) {
                    console.error(`Error en la generación (Intento ${currentRetry + 1}):`, error);
                    
                    // Si es un error 403, salimos inmediatamente sin reintentar
                    if (error.message.includes("403 Forbidden")) {
                        alert('Error crítico de API: La clave no es válida o no tiene permisos. Por favor, revisa tus credenciales.');
                        break; 
                    }

                    currentRetry++;
                    if (currentRetry < MAX_RETRIES) {
                        // Espera exponencial antes del próximo intento
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, currentRetry) * 1000));
                    } else {
                        alert('Error al generar la imagen después de varios intentos. Inténtalo de nuevo o revisa la foto.');
                    }
                }
            }

            // --- UI: Finalización de la Carga ---
            loadingSpinner.classList.add('hidden');
            generateButton.disabled = false;

            if (resultImage) {
                outputImage.src = resultImage;
                outputImage.style.display = 'block';
                downloadButton.classList.remove('hidden');
                socialInstructions.classList.remove('hidden');
            } else {
                outputImage.style.display = 'none';
                outputImage.src = ''; 
            }
        }
    </script>
</body>
</html>
