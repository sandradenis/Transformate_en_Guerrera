import gradio as gr
import torch
# ¡IMPORTANTE! Cambiado a StableDiffusionImg2ImgPipeline para la transformación
from diffusers import StableDiffusionPipeline, StableDiffusionImg2ImgPipeline
from PIL import Image
import os

# --- Configuration ---
BASE_MODEL_ID = "runwayml/stable-diffusion-v1-5" 
WARRIOR_PROMPT = (
    "full-body portrait of a strong, heroic female warrior in bronze and leather armor, holding a greatsword, "
    "standing in an epic medieval fantasy castle ruin, detailed textures, cinematic moody lighting, "
    "35mm photography style, photorealistic, dark tones, by Frank Frazetta and Greg Rutkowski."
)

# Global model handle
pipe = None

def initialize_pipeline():
    """Inicializa el Pipeline de Stable Diffusion (Image-to-Image)."""
    global pipe
    print(f"Initializing Stable Diffusion Img2Img Pipeline: {BASE_MODEL_ID}")
    try:
        # Usamos StableDiffusionImg2ImgPipeline para la transformación
        device = "cuda" if torch.cuda.is_available() else "cpu"
        dtype = torch.float16 if device == "cuda" else torch.float32 

        pipe = StableDiffusionImg2ImgPipeline.from_pretrained(
            BASE_MODEL_ID,
            torch_dtype=dtype,
            safety_checker=None
        ).to(device)
        print(f"Pipeline initialized on device: {device}")
    except Exception as e:
        print(f"Error initializing pipeline. Please ensure the model is accessible: {e}")
        pipe = None
        
# --- Core Image Generation Function (Img2Img) ---

def generate_warrior_princess(input_image: Image.Image, strength: float) -> Image.Image:
    """
    Genera una imagen de guerrera transformando la imagen de entrada.
    La 'strength' (Fuerza) controla cuánto se debe modificar la imagen original.
    """
    
    if pipe is None:
        raise gr.Error("El modelo de Stable Diffusion falló al inicializarse. No se puede generar la imagen.")
        
    if input_image is None:
        raise gr.Error("Por favor, sube tu foto antes de generar la guerrera.")

    print(f"Generating warrior princess with prompt: '{WARRIOR_PROMPT}' and strength: {strength}")
    
    # --- Generation Parameters ---
    num_inference_steps = 50 # Aumentado para mejor calidad
    guidance_scale = 9.0     # Aumentado para seguir el prompt con más fuerza
    seed = 42

    generator = torch.Generator(pipe.device).manual_seed(seed)

    # Llamada a la función Img2Img
    result = pipe(
        prompt=WARRIOR_PROMPT,
        image=input_image.convert("RGB"), # Aseguramos formato RGB
        strength=strength,                  # Parámetro crucial de Img2Img
        num_inference_steps=num_inference_steps,
        guidance_scale=guidance_scale,
        generator=generator
    )

    return result.images[0]

# --- Helper function for controlling the Generate button visibility ---

def handle_image_change(image_input):
    """
    Verifica si hay una imagen presente y actualiza la visibilidad del botón Generar.
    """
    if image_input is not None:
        return gr.update(visible=True)
    return gr.update(visible=False)


# --- Gradio Interface ---

def create_gradio_interface():
    """Configura y lanza la Interfaz Web de Gradio."""
    
    initialize_pipeline()
    
    if pipe is None:
        print("La app de Gradio no se lanzará porque el pipeline de Stable Diffusion falló al inicializarse.")
        with gr.Blocks(title="Error") as error_demo:
             gr.Markdown("## Error: Fallo en la Inicialización del Modelo")
             gr.Markdown("El modelo Stable Diffusion no pudo ser cargado. Revise los registros para más detalles.")
        return error_demo

    # Carga el contenido del CSS personalizado
    custom_css = ""
    if os.path.exists("style.css"): 
        try:
            with open("style.css", "r") as f:
                custom_css = f.read()
        except Exception as e:
            print(f"Error reading style.css: {e}")
            
    if not custom_css:
        print("Warning: style.css not found or empty. Running with default theme.")


    with gr.Blocks(title="Transformate en Guerrera", css=custom_css) as demo:
        
        # --- Title Section ---
        with gr.Group(elem_id="title-header"):
            gr.Markdown(
                "<h1 style='text-align: center;'>Transformate en Guerrera (v2.0 - Stable Diffusion)</h1>"
                "<p style='text-align: center;'>Sube tu foto y el modelo la transformará en una guerrera épica.</p>"
            )

        # --- Main Content Row: Input and Output Squares ---
        with gr.Row(equal_height=True):
            # Columna Izquierda: Imagen de Entrada
            with gr.Column(scale=1, min_width=300):
                input_image = gr.Image(
                    type="pil", 
                    label="1. Sube tu Foto", 
                    interactive=True, 
                    height=None, 
                    width=None, 
                    show_label=True, 
                    elem_id="input-image-area", 
                    elem_classes=["gradio-image-container"]
                )
                
            # Columna Derecha: Resultado
            with gr.Column(scale=1, min_width=300):
                output_image_display = gr.Image(
                    type="pil", 
                    label="2. Resultado de la Transformación", 
                    interactive=False, 
                    height=None, 
                    width=None,
                    elem_classes=["gradio-image-container"]
                )
        
        # --- Controles ---
        with gr.Row():
            with gr.Column(scale=1):
                # Slider para controlar la intensidad de la transformación (Fuerza)
                strength_slider = gr.Slider(
                    minimum=0.1, 
                    maximum=1.0, 
                    value=0.75, 
                    step=0.05, 
                    label="Fuerza de Transformación (Strength)",
                    info="Bajo (cercano a 0.1): Mantiene mucho de la foto original. Alto (cercano a 1.0): Transforma más agresivamente hacia el estilo guerrera."
                )
        
        # --- Botón de Acción ---
        generate_button = gr.Button(
            "Genera tu Guerrera", 
            variant="primary",
            elem_id="generate-btn",
            visible=False 
        )
            
        # --- Interactivity Logic ---
        
        # 1. Listener de Cambio de Imagen: Actualiza la visibilidad del botón Generar.
        input_image.change(
            fn=handle_image_change,
            inputs=[input_image],
            outputs=[generate_button],
            queue=False 
        )

        # 2. Generación: Usa la imagen y el slider de strength como inputs.
        generate_button.click(
            fn=generate_warrior_princess,
            inputs=[input_image, strength_slider], 
            outputs=output_image_display
        )
        
    return demo

# --- Application Entry Point ---
if __name__ == "__main__":
    app_demo = create_gradio_interface()
    if app_demo:
        app_demo.launch(share=False)
